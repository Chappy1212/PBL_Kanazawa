<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/app.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>レンズケア</title>
</head>


<body>
    <div class="container mt-4 text-center">
    <h1 class="mb-4 fw-bold text-center" style="font-size: 2.8rem; color: #00bcd4; letter-spacing: 0.07em; text-shadow: 0 2px 8px rgba(0,188,212,0.18); border-bottom: 3px solid #4dd0e1; padding-bottom: 0.25em;">レンズケア</h1>
        <div class="card mb-4 mx-auto" style="width: 50%;">
            <div class="card-body">
                <% if (lensInfos && lensInfos.length > 0) { %>
                    <ul class="list-group list-group-flush mb-3 p-2">
                       <li class="list-group-item fw-bold">交換予定日</li>
                       <li class="list-group-item fw-bold text-info fs-3"><%= new Date(lensInfos[0].exchangeDate).toLocaleDateString('ja-JP', { month: 'long', day: 'numeric' }) %></li>
                    </ul>
                    <!-- 円グラフを表示するパーシャルをインクルード -->
                    <%- include('partials/exchangeChart') %>
                    <form id="exchangeForm" method="post" action="/api/exchange" style="display:inline;">
                    <button type="submit" class="btn btn-primary btn-lg"><span class="exchange-text">( •᷄ •᷅ ).｡oｺｳｶﾝ…</span></button>
                    </form>
                    <ul class="list-group list-group-flush mb-3 p-2">
                        <li class="list-group-item"><span class="fw-bold"><%= lensInfos[0].title %></span></li>
                        <li class="list-group-item">在庫セット数: <span class="fw-bold"><%= lensInfos[0].stock %></span></li>
                        <li class="list-group-item">外す時間: <span class="fw-bold"><%= lensInfos[0].removeTime %></span></li>
                    </ul>
                    
                    <% if (daysUntilExchange === 0) { %>
                        <div class="alert alert-danger" role="alert">
                            本日は交換日です！レンズを交換してください。
                        </div>
                    <% } else if (daysUntilExchange < 0) { %>
                        <div class="alert alert-danger" role="alert">
                            交換日から <%= Math.abs(daysUntilExchange) %>日過ぎています！レンズを交換してください。
                        </div>
                    <% } %>
                    

                <% } else { %>
                    <p class="text-muted">レンズ情報はありません</p>
                <% } %>
            </div>
        </div>
                         <div class="d-flex justify-content-center gap-3 mb-3 btn-lg">
                          <% if (lensInfos && lensInfos.length == 0) { %>
             <a href="/register" class="btn btn-success">新規登録する</a>
        <% } %>
                        <a href="/settings" class="btn btn-outline-secondary">設定</a>
                        <a href="/history" class="btn btn-outline-info">交換履歴</a>
                        <form id="clearForm" method="post" action="/api/clear">
                            <button type="submit" class="btn btn-outline-danger">クリア</button>
                        </form>
                    </div>
    </div>

    
        <% let alertMsg = null;
             if (daysUntilExchange === 1 && lensInfos[0]?.type !== '1day') {
                 alertMsg = '明日は交換日です！';
             } else if (daysUntilExchange === 0) {
                 alertMsg = '本日は交換日です！レンズを交換してください。';
             } else if (daysUntilExchange < 0) {
                 alertMsg = '交換日が過ぎています！レンズを交換してください！';
             } else if (lensInfos && lensInfos[0]) {
                const lens = lensInfos[0];
                if (lens.type === '1day' && lens.stock <= 7) {
                    alertMsg = '在庫が少なくなっています！補充を検討してください。';
                } else if ((lens.type === '2week' || lens.type === '1month') && lens.stock <= 1) {
                    alertMsg = '在庫が少なくなっています！補充を検討してください。';
                }
             }
        %>

        <% if (alertMsg) { %>
                <script>
                        window.onload = function () {
                                alert('<%= alertMsg %>');
                        }
                </script>
        <% } %>

    <script>
        // サーバーからreminderを取得してremoveTimeを判定
        async function checkRemoveTime() {
            const res = await fetch('/api/reminder');
            const lensInfos = await res.json();
            const removeTime = lensInfos[0]?.removeTime;
            if (!removeTime) return;
            // removeTime判定ロジック
            const now = new Date();
            const hhmm = now.toTimeString().slice(0, 5);
            if (removeTime === hhmm) {
                alert('外す時間です！レンズを外してください。');
            }
        }
        // 60秒ごとにサーバーから最新情報を取得して判定
        setInterval(checkRemoveTime, 60000);
    </script>
</body>

</html>